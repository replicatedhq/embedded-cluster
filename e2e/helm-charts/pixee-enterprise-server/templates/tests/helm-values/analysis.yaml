{{- if hasKey .Values.global.pixee "tests" }}
{{- if .Values.global.pixee.tests.enabled | default false }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: analysis-tests-sa
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  labels:
    {{- include "analysis.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: "analysis-tests-role-{{ .Release.Namespace }}"
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "-4"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  labels:
    {{- include "analysis.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
rules:
- apiGroups: [""]
  resources: ["pods", "services"]
  verbs: ["get", "watch", "list"]
- apiGroups: [""]
  resources: ["pods/exec"]
  verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: "analysis-tests-rolebinding-{{ .Release.Namespace }}"
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "-3"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  labels:
    {{- include "analysis.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
subjects:
- kind: ServiceAccount
  name: analysis-tests-sa
  namespace: {{ .Release.Namespace }}
roleRef:
  kind: ClusterRole
  name: "analysis-tests-role-{{ .Release.Namespace }}"
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: Pod
metadata:
  name: "analysis-tests-helm-values"
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "-1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  labels:
    {{- include "analysis.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
spec:
  serviceAccountName: analysis-tests-sa
  containers:
    - name: test
      image: bitnami/kubectl:latest
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e

          echo "Testing Analysis service environment variables..."

          # Get the actual environment variables from the deployment using simplified label selection
          ANALYSIS_POD=$(kubectl get pods -l app.kubernetes.io/instance={{ .Release.Name }},app.kubernetes.io/name=analysis -o name | head -1)
          echo "Found analysis pod: $ANALYSIS_POD"
          DEPLOYMENT_ENV=$(kubectl exec $ANALYSIS_POD -- env | sort)

          # Check specific environment variables
          echo "Checking object store configuration..."
          echo "$DEPLOYMENT_ENV" | grep "OBJECT_STORE_ACCESS_KEY={{ .Values.global.pixee.objectStore.username }}" || exit 1
          echo "$DEPLOYMENT_ENV" | grep "OBJECT_STORE_SECRET_KEY={{ .Values.global.pixee.objectStore.password }}" || exit 1
          echo "$DEPLOYMENT_ENV" | grep "OBJECT_STORE_REGION={{ .Values.global.pixee.objectStore.region }}" || exit 1

          {{- if .Values.global.pixee.objectStore.endpoint }}
          echo "$DEPLOYMENT_ENV" | grep "OBJECT_STORE_URL={{ .Values.global.pixee.objectStore.endpoint }}" || exit 1
          {{- else }}
          echo "$DEPLOYMENT_ENV" | grep "OBJECT_STORE_URL=http://{{ .Release.Name }}-minio:9000/" || exit 1
          {{- end }}

          {{- if hasKey .Values "objectStore" }}
          {{- if .Values.objectStore.bucket }}
          echo "$DEPLOYMENT_ENV" | grep "WORKFLOW_BUCKET={{ .Values.objectStore.bucket }}" || exit 1
          {{- end }}
          echo "$DEPLOYMENT_ENV" | grep "WORKFLOW_BUCKET=pixee-analysis-service" || exit 1
          {{- end }}

          {{- if hasKey .Values.global.pixee "ai" }}
          {{- if .Values.global.pixee.ai.enabled }}
          echo "Checking AI configuration..."
          {{- if eq .Values.global.pixee.ai.provider "openai" }}
          {{- if not (empty (dig "pixee" "ai" "openai" "key" "" .Values.global)) }}
          echo "$DEPLOYMENT_ENV" | grep "CODEMODDER_OPENAI_API_KEY" || exit 1
          {{- end }}
          {{- end }}
          {{- if eq .Values.global.pixee.ai.provider "azure" }}
          {{- if not (empty (dig "pixee" "ai" "azure" "key" "" .Values.global)) }}
          echo "$DEPLOYMENT_ENV" | grep "CODEMODDER_AZURE_OPENAI_API_KEY" || exit 1
          {{- end }}
          echo "$DEPLOYMENT_ENV" | grep "CODEMODDER_AZURE_OPENAI_ENDPOINT={{ .Values.global.pixee.ai.azure.endpoint }}" || exit 1
          echo "$DEPLOYMENT_ENV" | grep "CODEMODDER_AZURE_OPENAI_GPT_4O_2024_05_13_DEPLOYMENT={{ dig "pixee" "ai" "azure" "deployments" "gpt-4o-2024-05-13" "gpt-4o-2024-05-13" .Values.global }}" || exit 1
          echo "$DEPLOYMENT_ENV" | grep "CODEMODDER_AZURE_OPENAI_O3_MINI_DEPLOYMENT={{ dig "pixee" "ai" "azure" "deployments" "o3-mini" "o3-mini" .Values.global }}" || exit 1
          {{- if not (empty (dig "pixee" "ai" "azure" "llama" "endpoint" "" .Values.global)) }}
          echo "$DEPLOYMENT_ENV" | grep "CODEMODDER_AZURE_LLAMA_ENDPOINT={{ .Values.global.pixee.ai.azure.llama.endpoint }}" || exit 1
          {{- end }}
          {{- end }}
          {{- end }}
          {{- end }}

          {{- if hasKey .Values.global.pixee "sentry" }}
          {{- if .Values.global.pixee.sentry.enabled }}
          echo "Checking Sentry configuration..."
          echo "$DEPLOYMENT_ENV" | grep "SENTRY_DSN" || exit 1
          echo "$DEPLOYMENT_ENV" | grep "SENTRY_ENVIRONMENT" || exit 1
          echo "$DEPLOYMENT_ENV" | grep "SENTRY_RELEASE" || exit 1
          {{- if not (empty (dig "pixee" "url" "" .Values.global)) }}
          echo "$DEPLOYMENT_ENV" | grep "SENTRY_SERVER={{ .Values.global.pixee.url }}" || exit 1
          {{- end }}
          {{- end }}
          {{- end }}

          # Check custom environment variables if defined
          {{- if hasKey .Values "env" }}
          {{- range $key, $value := .Values.env }}
          echo "Checking custom env var {{ $key }}..."
          echo "$DEPLOYMENT_ENV" | grep "{{ $key }}={{ $value }}" || exit 1
          {{- end }}
          {{- end }}

          # Check debug environment variables
          {{- if .Values.debug }}
          echo "Checking debug configuration..."
          echo "$DEPLOYMENT_ENV" | grep "DEBUG=true" || exit 1
          echo "$DEPLOYMENT_ENV" | grep "CODEMODDER_DEBUG=true" || exit 1
          {{- end }}

          echo "All Analysis environment variables tests passed!"
  restartPolicy: Never
{{- end }}
{{- end }}