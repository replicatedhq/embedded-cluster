name: Makefile Dependencies
on:
  schedule:
  # everyday at midnight.
  - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      k0s_minor_version:
        description: 'The minor version of k0s to update the dependencies for'
        required: false

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    steps:
    - name: Check out repo
      uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache-dependency-path: "**/*.sum"
    - name: K0s
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cur_minor="$INPUT_K0S_MINOR_VERSION"
        if [ -z "$cur_minor" ]; then
          cur_minor=$(make print-K0S_VERSION | awk -F'.' '{print $2}')
        fi

        ./scripts/update-k0s-dep-version.sh "$cur_minor"
    - name: Troubleshoot
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        export VERSION=$(gh release list --repo replicatedhq/troubleshoot --json name,isLatest | jq -r '.[] | select(.isLatest)|.name')
        sed -i "/^TROUBLESHOOT_VERSION/c\TROUBLESHOOT_VERSION = $VERSION" Makefile
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GH_PAT }}
        commit-message: Update Makefile versions
        title: 'Update Makefile versions'
        branch: automation/update-makefile
        delete-branch: true
        labels: |
          automated-pr
          makefile
          type::chore
        draft: false
        base: "main"
        body: |
          Automated changes by the [cron-makefile-dependencies](https://github.com/replicatedhq/embedded-cluster/blob/main/.github/workflows/dependencies.yaml) GitHub action

