name: Makefile Dependencies
on:
  schedule:
  # everyday at midnight.
  - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      k0s_minor_version:
        description: 'The minor version of k0s to update the dependencies for'
        required: false

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    steps:
    - name: Check out repo
      uses: actions/checkout@v5
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache-dependency-path: "**/*.sum"
    - name: Get K0s minor version
      run: |
        k0s_minor_version=$(make print-K0S_MINOR_VERSION)
        if [ -n "$INPUT_K0S_MINOR_VERSION" ]; then
          k0s_minor_version=$INPUT_K0S_MINOR_VERSION
        fi
        echo "K0S_MINOR_VERSION=$k0s_minor_version"
        echo "K0S_MINOR_VERSION=$k0s_minor_version" >> $GITHUB_ENV
    - name: K0s minus 2
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        K0S_MINOR_VERSION=$((K0S_MINOR_VERSION - 2))
        ./scripts/k0s-update-dependencies.sh "$K0S_MINOR_VERSION"
    - name: K0s minus 1
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        K0S_MINOR_VERSION=$((K0S_MINOR_VERSION - 1))
        ./scripts/k0s-update-dependencies.sh "$K0S_MINOR_VERSION"
    - name: K0s
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        ./scripts/k0s-update-dependencies.sh "$K0S_MINOR_VERSION"
    - name: Troubleshoot
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        version=$(gh release list --repo replicatedhq/troubleshoot --json name,isLatest | jq -r '.[] | select(.isLatest)|.name')
        sed -i "/^TROUBLESHOOT_VERSION/c\TROUBLESHOOT_VERSION = $version" versions.mk
    - name: FIO
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        version=$(gh release list --repo axboe/fio --json name,isLatest | jq -r '.[] | select(.isLatest)|.name' | cut -d- -f2)
        sed -i "/^FIO_VERSION/c\FIO_VERSION = $version" versions.mk
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GH_PAT }}
        commit-message: Update Makefile versions
        title: 'Update Makefile versions'
        branch: automation/update-makefile
        delete-branch: true
        labels: |
          automated-pr
          makefile
          type::chore
        draft: false
        body: |
          Automated changes by the [cron-makefile-dependencies](https://github.com/replicatedhq/embedded-cluster/blob/main/.github/workflows/dependencies.yaml) GitHub action
